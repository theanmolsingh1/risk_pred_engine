<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Health Risk Prediction Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: url('https://images.unsplash.com/photo-1615840636404-0f2412fd2732?q=80&w=406&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D') no-repeat center center fixed;
      background-size: cover;
    }

    /* body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      max-width: 1200px; 
      margin: 20px auto; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    } */
    
    .container {
      background:  rgb(197, 224, 242);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    h1 { 
      font-size: 28px; 
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .nav-buttons {
      display: flex;
      gap: 10px;
    }
    
    .nav-button {
      background: linear-gradient(45deg, #6c757d, #495057);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      text-decoration: none;
      font-weight: 600;
      transition: transform 0.2s;
    }
    
    .nav-button:hover {
      transform: translateY(-2px);
    }
    
    .nav-button.chatbot {
      background: linear-gradient(45deg, #ff6b6b, #ee5a24);
    }
    
    .ai-chat-section {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 1px solid #ddd;
    }
    
    .ai-chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .ai-chat-toggle {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s;
    }
    
    .ai-chat-toggle:hover {
      transform: translateY(-2px);
    }
    
    .ai-chat-container {
      display: none;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: white;
      margin-bottom: 15px;
    }
    
    .ai-chat-container.active {
      display: block;
    }
    
    .ai-chat-messages {
      padding: 15px;
      min-height: 200px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .ai-message {
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 15px;
      max-width: 80%;
      word-wrap: break-word;
    }
    
    .ai-message.user {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      margin-left: auto;
      text-align: right;
    }
    
    .ai-message.assistant {
      background: #f8f9fa;
      color: #333;
      margin-right: auto;
      border-left: 4px solid #28a745;
      line-height: 1.6;
    }
    
    .ai-message.assistant p {
      margin: 0;
    }
    
    .ai-message.assistant strong {
      color: #28a745;
      font-weight: 600;
    }
    
    .ai-chat-input {
      display: flex;
      gap: 10px;
      padding: 15px;
      border-top: 1px solid #ddd;
    }
    
    .ai-chat-input input {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 20px;
      outline: none;
    }
    
    .ai-chat-input button {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .ai-chat-input button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .typing-indicator {
      display: none;
      padding: 10px 15px;
      color: #666;
      font-style: italic;
    }
    
    .upload-section {
      text-align: center;
      padding: 40px;
      border: 2px dashed #ddd;
      border-radius: 10px;
      margin-bottom: 30px;
    }
    
    .input-group {
      margin-bottom: 20px;
      text-align: left;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    
    .input-group input,
    .input-group select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-color: #667eea;
    } 
    
    .dashboard-section {
      /* color :#155724 */
      display: none;
    }
    
    .dashboard-section.active {
      display: block;
    }
    
    label { 
      display: block; 
      margin-top: 15px; 
      font-weight: 600;
      color: #555;
    }
    
    input[type="file"] {
      margin: 15px 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      width: 300px;
    }
    
    button {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: transform 0.2s;
    }
    
    button:hover {
      transform: translateY(-2px);
    }
    
    .error { 
      color: #e74c3c; 
      font-weight: 600;
    }
    
    .success {
      color: #27ae60;
      font-weight: 600;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #0b8ddf, #20beea 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-card h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      opacity: 0.9;
    }
    
    .stat-card .value {
      font-size: 24px;
      font-weight: bold;
    }
    
    .chart-container {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      height: 450px;
      overflow: hidden;
    }
    
    canvas { 
      max-width: 100%; 
      height: 400px !important;
      max-height: 400px !important;
    }
    
    .insights {
      background: #e8f4fd;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      border-left: 4px solid #3498db;
    }
    
    .insights h3 {
      color: #2c3e50;
      margin-top: 0;
    }
    
    .risk-level {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      margin-left: 10px;
    }
    
    .risk-low { background: #d4edda; color: #155724; }
    .risk-medium { background: #fff3cd; color: #856404; }
    .risk-high { background: #f8d7da; color: #721c24; }
    
    .back-button {
      background: linear-gradient(45deg, #6c757d, #495057);
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <!-- Authentication Check -->
  <script>
    // Check if user is authenticated
    if (sessionStorage.getItem('isAuthenticated') !== 'true') {
      // User is not authenticated, redirect to login
      window.location.href = '/login';
    }
  </script>
  <div class="container">
    <button class="back-button" onclick="window.location.href='/dashboard'">‚Üê Back to Dashboard</button>
    
    <div class="header-nav">
      <h1 style="margin: 0;">Health Risk Prediction Dashboard</h1>
      <div class="nav-buttons">
        <a href="/dashboard" class="nav-button">Dashboard</a>
        <button onclick="logout()" class="nav-button" style="background: linear-gradient(45deg, #ed9085, #f37668); border: none; cursor: pointer;">Logout</button>
      </div>
    </div>
    
    <!-- Upload Section -->
    <div id="uploadSection" class="upload-section">
      <h2>üìÅ Upload Patient Data</h2>
      <p>Please provide your information and upload a CSV file containing your health data for analysis</p>
      <form id="uploadForm">
        <div class="input-group">
          <label for="patientName">Full Name:</label>
          <input type="text" id="patientName" name="patientName" placeholder="Enter your full name" required />
        </div>
        
        <div class="input-group">
          <label for="patientSex">‚ö• Sex:</label>
          <select id="patientSex" name="patientSex" required>
            <option value="">Select your sex</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>
        </div>
        
        <div class="input-group">
          <label for="file">üìÑ Health Data File (CSV):</label>
          <input type="file" id="file" name="file" accept=".csv" required />
        </div>
        
        <button type="submit">Analyze Data & Generate Report</button>
      </form>
      <p id="status"></p>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="dashboard-section">
      <h2>Health Risk Analysis Report</h2>
      
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Days</h3>
          <div class="value" id="totalPatients">-</div>
        </div>
        <div class="stat-card">
          <h3>Probability of Deterioration for Next 90 Days</h3>
          <div class="value" id="avgRisk">-</div>
        </div>
        <div class="stat-card">
          <h3>High Risk Days</h3>
          <div class="value" id="highRiskCount">-</div>
        </div>
        <div class="stat-card">
          <h3>Overall Risk Level</h3>
          <div class="value" id="overallRisk">-</div>
        </div>
      </div>
      
      <div class="chart-container">
        <h3>Risk Trend Analysis</h3>
        <canvas id="chart"></canvas>
      </div>
      
      <div class="insights">
        <h3>Key Insights</h3>
        <div id="insights"></div>
      </div>
      
      <!-- <div class="insights">
        <h3>AI Explanation</h3>
        <div id="aiExplanation"></div>
      </div> -->
      
      <!-- AI Chat Interface -->
      <div class="ai-chat-section">
        <div class="ai-chat-header">
          <h3>AI Health Assistant</h3>
          <button id="toggleAIChat" class="ai-chat-toggle">Ask AI About Your Data</button>
        </div>
        
        <div id="aiChatContainer" class="ai-chat-container">
          <div id="aiChatMessages" class="ai-chat-messages">
            <div class="ai-message assistant">
              üëã Hi! I'm your AI Health Assistant. I can analyze your uploaded health data and answer questions about risk patterns, trends, and provide insights. Ask me anything about your data!
              <br><br> 
            </div>
          </div>
          
          <div id="typingIndicator" class="typing-indicator">
            I am thinking...
          </div>
          
          <div class="ai-chat-input">
            <input type="text" id="aiChatInput" placeholder="Ask me about your health data, risk patterns, trends..." />
            <button id="aiChatSend">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById("uploadForm");
    const status = document.getElementById("status");
    const uploadSection = document.getElementById("uploadSection");
    const dashboardSection = document.getElementById("dashboardSection");
    let myChart = null;
    let analysisData = null;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      status.textContent = "Processing your data...";
      status.className = "success";

      const fileInput = document.getElementById("file");
      const nameInput = document.getElementById("patientName");
      const sexInput = document.getElementById("patientSex");
      
      if (fileInput.files.length === 0) {
        status.textContent = "Please select a CSV file.";
        status.className = "error";
        return;
      }
      
      if (!nameInput.value.trim()) {
        status.textContent = "Please enter your name.";
        status.className = "error";
        return;
      }
      
      if (!sexInput.value) {
        status.textContent = "Please select your sex.";
        status.className = "error";
        return;
      }

      const fd = new FormData();
      fd.append("file", fileInput.files[0]);
      fd.append("patientName", nameInput.value.trim());
      fd.append("patientSex", sexInput.value);

      try {
        const res = await fetch("http://127.0.0.1:5000/upload", {
          method: "POST",
          body: fd
        });
        const data = await res.json();
        if (!res.ok) {
          status.textContent = data.error || "Server error";
          status.className = "error";
          return;
        }

        // Store analysis data
        analysisData = data;
        currentAnalysisData = data;
        
        // Hide upload section and show dashboard
        uploadSection.style.display = "none";
        dashboardSection.classList.add("active");
        
        // Populate dashboard with data
        populateDashboard(data);
        
        // Auto-open AI chat to show analysis
        setTimeout(() => {
          const chatContainer = document.getElementById('aiChatContainer');
          const toggleBtn = document.getElementById('toggleAIChat');
          if (chatContainer && !chatContainer.classList.contains('active')) {
            chatContainer.classList.add('active');
            toggleBtn.textContent = 'Close AI Chat';
            
            // Provide initial AI analysis
            setTimeout(() => {
              addAIMessage("What does my health data mean?", 'user');
              sendAIMessage();
            }, 1000);
          }
        }, 2000);
        
      } catch (err) {
        status.textContent = "Request failed: " + err.message;
        status.className = "error";
      }
    });

    function populateDashboard(data) {
      const predictions = data.predictions;
      const average = data.average;
      const nRows = data.n_rows;
      
      // Calculate statistics
      const highRiskCount = predictions.filter(p => p > 0.5).length;
      const riskLevel = getRiskLevel(average);
      
      // Update stat cards
      document.getElementById("totalPatients").textContent = nRows;
      document.getElementById("avgRisk").textContent = average.toFixed(3);
      document.getElementById("highRiskCount").textContent = highRiskCount;
      
      const overallRiskEl = document.getElementById("overallRisk");
      overallRiskEl.textContent = riskLevel.text;
      overallRiskEl.className = `risk-level ${riskLevel.class}`;
      
      // Draw enhanced chart
      drawEnhancedChart(predictions);
      
        // Generate insights
        generateInsights(predictions, average, highRiskCount, nRows);
        
        // Display AI explanation
        displayAIExplanation(data.ai_explanation);
    }

    function getRiskLevel(average) {
      if (average < 0.3) {
        return { text: "LOW", class: "risk-low" };
      } else if (average < 0.7) {
        return { text: "MEDIUM", class: "risk-medium" };
      } else {
        return { text: "HIGH", class: "risk-high" };
      }
    }

    function drawEnhancedChart(predictions) {
      const ctx = document.getElementById("chart").getContext("2d");
      const labels = predictions.map((_, i) => `Day ${i + 1}`);
      
      if (myChart) myChart.destroy();
      
      myChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Risk Score",
            data: predictions,
            borderColor: "rgb(75, 192, 192)",
            backgroundColor: "rgba(75, 192, 192, 0.1)",
            borderWidth: 3,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          },
          scales: {
            x: { 
              title: { 
                display: true, 
                text: "Day",
                font: { size: 14, weight: 'bold' }
              },
              grid: {
                display: true,
                color: 'rgba(0,0,0,0.1)'
              }
            },
            y: { 
              title: { 
                display: true, 
                text: "Risk Score (0-1)",
                font: { size: 14, weight: 'bold' }
              },
              min: 0,
              max: 1,
              grid: {
                display: true,
                color: 'rgba(0,0,0,0.1)'
              }
            }
          },
          elements: {
            point: {
              radius: 4,
              hoverRadius: 8
            }
          }
        }
      });
    }

    function generateInsights(predictions, average, highRiskCount, totalDays) {
      const insightsEl = document.getElementById("insights");
      const highRiskPercentage = ((highRiskCount / totalDays) * 100).toFixed(1);
      const lowRiskCount = predictions.filter(p => p < 0.3).length;
      const mediumRiskCount = predictions.filter(p => p >= 0.3 && p <= 0.7).length;
      
      let insights = `
        <ul style="list-style: none; padding: 0;">
          <li style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
            <strong>Overall Analysis:</strong> ${totalDays} days analyzed with an average risk score of ${average.toFixed(3)}
          </li>
          <li style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
            <strong>High Risk Days:</strong> ${highRiskCount} days (${highRiskPercentage}%) showed elevated risk levels
          </li>
          <li style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
            <strong>Risk Distribution:</strong> ${lowRiskCount} low risk days, ${mediumRiskCount} medium risk days, ${highRiskCount} high risk days
          </li>
          <li style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
            <strong>Recommendation:</strong> ${getRecommendation(average, highRiskPercentage)}
          </li>
        </ul>
      `;
      
      insightsEl.innerHTML = insights;
    }

    function getRecommendation(average, highRiskPercentage) {
      if (average < 0.3) {
        return "Continue regular monitoring. Patient shows consistently low risk levels.";
      } else if (average < 0.7) {
        return "Implement enhanced monitoring protocols. Consider preventive interventions for this patient.";
      } else {
        return "URGENT: Implement immediate intervention protocols. Patient shows high risk levels requiring intensive care.";
      }
    }

    function displayAIExplanation(explanation) {
      const aiExplanationEl = document.getElementById('aiExplanation');
      if (explanation) {
        // Convert markdown-style formatting to HTML
        let formattedExplanation = explanation
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/\n\n/g, '</p><p>')
          .replace(/\n/g, '<br>');
        
        aiExplanationEl.innerHTML = `
          <div style="background: white; padding: 20px; border-radius: 8px; border-left: 3px solid #4CAF50;">
            <div style="margin: 0; line-height: 1.6; color: #333; font-size: 14px;">
              <p>${formattedExplanation}</p>
            </div>
          </div>
        `;
      } else {
        aiExplanationEl.innerHTML = '<p style="color: #666; font-style: italic;">AI explanation not available.</p>';
      }
    }

    // AI Chat Functionality
    let currentAnalysisData = null;
    
    function toggleAIChat() {
      const chatContainer = document.getElementById('aiChatContainer');
      const toggleBtn = document.getElementById('toggleAIChat');
      
      if (chatContainer.classList.contains('active')) {
        chatContainer.classList.remove('active');
        toggleBtn.textContent = 'üí¨ Ask AI About Your Data';
      } else {
        chatContainer.classList.add('active');
        toggleBtn.textContent = 'Close AI Chat';
      }
    }
    
    function addAIMessage(content, sender) {
      const messagesContainer = document.getElementById('aiChatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `ai-message ${sender}`;
      
      if (sender === 'assistant') {
        // Format AI response with better styling
        const formattedContent = content
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/\n\n/g, '</p><p>')
          .replace(/\n/g, '<br>')
          .replace(/üìä|üìà|üî¥|üü°|üü¢|üí°|‚ö†Ô∏è|‚úÖ|‚ùå|üè•|üíä|üèÉ|üçé|üíß|üòä|üòü|üò∞/g, '');
        
        messageDiv.innerHTML = `<p>${formattedContent}</p>`;
      } else {
        messageDiv.textContent = content;
      }
      
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function showTypingIndicator() {
      document.getElementById('typingIndicator').style.display = 'block';
    }
    
    function hideTypingIndicator() {
      document.getElementById('typingIndicator').style.display = 'none';
    }
    
    async function sendAIMessage() {
      const input = document.getElementById('aiChatInput');
      const sendBtn = document.getElementById('aiChatSend');
      const message = input.value.trim();
      
      if (!message) return;
      
      if (!currentAnalysisData) {
        addAIMessage('Please upload and analyze your data first to use the AI assistant.', 'assistant');
        return;
      }
      
      // Add user message
      addAIMessage(message, 'user');
      input.value = '';
      sendBtn.disabled = true;
      showTypingIndicator();
      
      try {
        const response = await fetch('/api/local-ai/analyze', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            query: message,
            analysis_data: currentAnalysisData
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          addAIMessage(data.response, 'assistant');
        } else {
          addAIMessage(`Error: ${data.error}`, 'assistant');
        }
      } catch (error) {
        addAIMessage(`Sorry, I encountered an error: ${error.message}`, 'assistant');
      } finally {
        hideTypingIndicator();
        sendBtn.disabled = false;
        input.focus();
      }
    }
    
    // Logout function
    async function logout() {
      try {
        // Call logout API to clear server-side session
        await fetch('/api/auth/logout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
      } catch (error) {
        console.error('Logout API error:', error);
      }
      
      // Clear session storage
      sessionStorage.removeItem('user');
      sessionStorage.removeItem('isAuthenticated');
      
      // Redirect to login page
      window.location.href = '/login';
    }

    // Add event listeners for AI chat
    document.addEventListener('DOMContentLoaded', function() {
      const toggleBtn = document.getElementById('toggleAIChat');
      const sendBtn = document.getElementById('aiChatSend');
      const input = document.getElementById('aiChatInput');
      
      if (toggleBtn) {
        toggleBtn.addEventListener('click', toggleAIChat);
      }
      
      if (sendBtn) {
        sendBtn.addEventListener('click', sendAIMessage);
      }
      
      if (input) {
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            sendAIMessage();
          }
        });
      }
    });
  </script>
</body>
</html>
